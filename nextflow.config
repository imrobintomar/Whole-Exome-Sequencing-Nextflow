// ==========================================
// Nextflow Configuration File
// Whole Exome Sequencing Pipeline (WES)
// Production-grade, DSL2 compliant
// ==========================================

nextflow.enable.dsl = 2

env {
  GATK_HOME = '/media/drprabudh/m2/tools/gatk-4.6.2.0'
  PATH = "/home/drprabudh/bin:${GATK_HOME}:${PATH}"
}


// -------------------------------------------------
// Manifest
// -------------------------------------------------
manifest {
    name        = 'Whole Exome Sequencing Pipeline'
    description = 'WES pipeline with QC, alignment, BQSR, variant calling and annotation'
    version     = '1.0'
    author      = 'Robin Tomar'
    homePage    = 'https://github.com/imrobintomar/Whole-Exome-Sequencing-Nextflow.git'
    mainScript  = 'main.nf'
}

// -------------------------------------------------
// Author Authentication & Pipeline Protection
// -------------------------------------------------
// Validation has been disabled for troubleshooting

// -------------------------------------------------
// Global parameters
// -------------------------------------------------
params {
    input_dir   = '/home/drprabudh/Documents/test'
    output_dir  = '/home/drprabudh/Documents/test/output'

    reference        = '/media/drprabudh/m1/hg38/hg38.fa'
    reference_index  = '/media/drprabudh/m1/hg38/hg38.fa.fai'
    reference_dict   = '/media/drprabudh/m1/hg38/hg38.dict'
    bwa_index        = '/media/drprabudh/m1/hg38/hg38.fa'

    known_sites = [
        '/media/drprabudh/m1/vcf_file/Homo_sapiens_assembly38.known_indels.vcf.gz',
        '/media/drprabudh/m1/vcf_file/Mills_and_1000G_gold_standard.indels.hg38.vcf.gz'
    ]

    annovar_dir      = '/media/drprabudh/m1/annovar'
    annovar_db       = '/media/drprabudh/m1/annovar/hg38_humandb'
    annovar_xreffile = '/media/drprabudh/m1/annovar/dbnsfp/gene/dbNSFP4.7_gene'
    thousand_genomes_dir = '/media/drprabudh/m1/annovar/1000'
    snpsift_jar      = '/media/drprabudh/m1/annovar/snpEff/SnpSift.jar'

    max_af     = 0.05
    min_depth = 5

    resource_mode = 'auto'   // auto | conservative | aggressive
}

// -------------------------------------------------
// Resource helpers
// -------------------------------------------------
def maxCores    = Runtime.runtime.availableProcessors()
def maxMemoryGB = 128   // hard safety cap for local execution

def modeScale = [
    auto:         [cpu: 0.8, mem: 0.8],
    conservative: [cpu: 0.5, mem: 0.5],
    aggressive:   [cpu: 0.95, mem: 0.95]
]

// Get resource mode from params, default to 'auto'
def currentMode = params.resource_mode ?: 'auto'
def cpuFrac = modeScale[currentMode].cpu
def memFrac = modeScale[currentMode].mem

// Pre-compute resource values for each process
def cpusPct = { pct -> Math.max(1, (maxCores * cpuFrac * pct / 100).toInteger()) }
def memPct  = { pct -> "${Math.max(4, (maxMemoryGB * memFrac * pct / 100).toInteger())} GB" }

// Pre-calculated values to avoid closure issues
def cpu_25 = Math.max(1, (maxCores * cpuFrac * 25 / 100).toInteger())
def cpu_15 = Math.max(1, (maxCores * cpuFrac * 15 / 100).toInteger())
def cpu_20 = Math.max(1, (maxCores * cpuFrac * 20 / 100).toInteger())
def cpu_30 = Math.max(1, (maxCores * cpuFrac * 30 / 100).toInteger())
def cpu_35 = Math.max(1, (maxCores * cpuFrac * 35 / 100).toInteger())
def cpu_40 = Math.max(1, (maxCores * cpuFrac * 40 / 100).toInteger())
def cpu_80 = Math.max(1, (maxCores * cpuFrac * 80 / 100).toInteger())
def cpu_85 = Math.max(1, (maxCores * cpuFrac * 85 / 100).toInteger())

def mem_10 = "${Math.max(4, (maxMemoryGB * memFrac * 10 / 100).toInteger())} GB"
def mem_15 = "${Math.max(4, (maxMemoryGB * memFrac * 15 / 100).toInteger())} GB"
def mem_20 = "${Math.max(4, (maxMemoryGB * memFrac * 20 / 100).toInteger())} GB"
def mem_25 = "${Math.max(4, (maxMemoryGB * memFrac * 25 / 100).toInteger())} GB"
def mem_35 = "${Math.max(4, (maxMemoryGB * memFrac * 35 / 100).toInteger())} GB"
def mem_45 = "${Math.max(4, (maxMemoryGB * memFrac * 45 / 100).toInteger())} GB"
def mem_60 = "${Math.max(4, (maxMemoryGB * memFrac * 60 / 100).toInteger())} GB"
def mem_65 = "${Math.max(4, (maxMemoryGB * memFrac * 65 / 100).toInteger())} GB"
def mem_70 = "${Math.max(4, (maxMemoryGB * memFrac * 70 / 100).toInteger())} GB"
def mem_75 = "${Math.max(4, (maxMemoryGB * memFrac * 75 / 100).toInteger())} GB"

// -------------------------------------------------
// Executor
// -------------------------------------------------
executor {
    name              = 'local'
    cpus              = maxCores
    memory            = "${maxMemoryGB} GB"
    queueSize         = 12
    submitRateLimit   = '5 sec'
    exitReadTimeout   = '270 sec'
    pollInterval      = '30 sec'
    queueStatInterval = '1 min'
}

// -------------------------------------------------
// Unified process configuration
// -------------------------------------------------
process {
    executor   = 'local'
    publishDir = params.output_dir

    errorStrategy = { task.exitStatus in [137,140,143] ? 'retry' : 'finish' }
    maxRetries    = 3
    maxRetryDelay = '2h'

    // ---------------- QC ----------------
    withName: fastpQC {
        container  = 'docker://biocontainers/fastp:v0.23.4-1'
        cpus       = cpu_25
        memory     = mem_20
        time       = '4h'
        publishDir = "${params.output_dir}/filtered_fastp"
    }

    // ---------------- Alignment ----------------
    withName: bwaMem {
        container  = 'docker://biocontainers/bwa:v0.7.17-1'
        cpus       = cpu_80
        memory     = mem_75
        time       = '12h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    // ---------------- BAM processing ----------------
    withName: sortSam {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpu_30
        memory     = mem_35
        time       = '3h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    withName: flagstat {
        container  = 'docker://biocontainers/samtools:v1.17-1'
        cpus       = cpu_15
        memory     = mem_10
        time       = '45m'
        publishDir = "${params.output_dir}/Mapsam"
    }

    withName: markDuplicates {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpu_40
        memory     = mem_60
        time       = '6h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    withName: sortSamPostDedup {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpu_30
        memory     = mem_35
        time       = '3h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    // ---------------- BQSR ----------------
    withName: baseRecalibrator {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpu_85
        memory     = mem_70
        time       = '10h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    withName: applyBQSR {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpu_35
        memory     = mem_45
        time       = '4h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    // ---------------- Variant Calling ----------------
    withName: haplotypeCaller {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpu_85
        memory     = mem_75
        time       = '12h'
        publishDir = "${params.output_dir}/Germline_VCF"
    }

    // ---------------- Annotation ----------------
    withName: snpsiftAnnotate1000G {
        container  = 'docker://biocontainers/snpsift:4.3.1-1'
        cpus       = cpu_30
        memory     = mem_25
        time       = '6h'
        publishDir = "${params.output_dir}/Germline_VCF"
    }

    withName: annovarAnnotate {
        container  = 'docker://biocontainers/annovar:20230520-1'
        cpus       = cpu_80
        memory     = mem_65
        time       = '10h'
        publishDir = "${params.output_dir}/Germline_VCF"
    }

    withName: extractFilterFields {
        container  = 'docker://biocontainers/snpsift:4.3.1-1'
        cpus       = cpu_20
        memory     = mem_15
        time       = '2h'
        publishDir = "${params.output_dir}/Germline_VCF"
    }
}

// -------------------------------------------------
// Profiles
// -------------------------------------------------
profiles {

    standard {
        process.executor = 'local'
    }

    slurm {
        process.executor = 'slurm'
        process.queue    = 'default'
        executor.queueSize = 20
    }

    docker {
        docker.enabled = true
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
    }

    conservative {
        params.resource_mode = 'conservative'
    }

    aggressive {
        params.resource_mode = 'aggressive'
    }
}

// -------------------------------------------------
// Reports
// -------------------------------------------------
trace {
    enabled   = true
    file      = "${params.output_dir}/logs/trace.txt"
    overwrite = true
}

report {
    enabled   = true
    file      = "${params.output_dir}/logs/report.html"
    overwrite = true
}

timeline {
    enabled   = true
    file      = "${params.output_dir}/logs/timeline.html"
    overwrite = true
}

dag {
    enabled   = true
    file      = "${params.output_dir}/logs/pipeline.svg"
    overwrite = true
}
