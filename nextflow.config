// ==========================================
// Nextflow Configuration File
// Whole Exome Sequencing Pipeline (WES)
// Production-grade, DSL2 compliant
// ==========================================

nextflow.enable.dsl = 2

// -------------------------------------------------
// Manifest
// -------------------------------------------------
manifest {
    name        = 'Whole Exome Sequencing Pipeline'
    description = 'WES pipeline with QC, alignment, BQSR, variant calling and annotation'
    version     = '1.0'
    author      = 'Robin Tomar'
    homePage    = 'https://github.com/imrobintomar/Whole-Exome-Sequencing-Nextflow.git'
    mainScript  = 'main.nf'
}

// -------------------------------------------------
// Author Authentication & Pipeline Protection
// -------------------------------------------------
// Validation has been disabled for troubleshooting

// -------------------------------------------------
// Global parameters
// -------------------------------------------------
params {
    input_dir   = '/media/drprabudh/m3/PRJNA855946/FASTQ'
    output_dir  = '/media/drprabudh/m3/PRJNA855946/results'

    reference        = '/media/drprabudh/m1/hg38/hg38.fa'
    reference_index  = '/media/drprabudh/m1/hg38/hg38.fa.fai'
    reference_dict   = '/media/drprabudh/m1/hg38/hg38.dict'
    bwa_index        = '/media/drprabudh/m1/hg38/hg38.fa'

    known_sites = [
        '/media/drprabudh/m1/vcf_file/Homo_sapiens_assembly38.known_indels.vcf.gz',
        '/media/drprabudh/m1/vcf_file/Mills_and_1000G_gold_standard.indels.hg38.vcf.gz'
    ]

    annovar_dir      = '/media/drprabudh/m1/annovar'
    annovar_db       = '/media/drprabudh/m1/annovar/hg38_humandb'
    annovar_xreffile = '/media/drprabudh/m1/annovar/dbnsfp/gene/dbNSFP4.7_gene'
    thousand_genomes_dir = '/media/drprabudh/m1/annovar/1000'
    snpsift_jar      = '/media/drprabudh/m1/annovar/snpEff/snpEff.jar'

    max_af     = 0.05
    min_depth = 5

    resource_mode = 'auto'   // auto | conservative | aggressive
}

// -------------------------------------------------
// Resource helpers
// -------------------------------------------------
def maxCores    = Runtime.runtime.availableProcessors()
def maxMemoryGB = 128   // hard safety cap for local execution

def modeScale = [
    auto:         [cpu: 0.8, mem: 0.8],
    conservative: [cpu: 0.5, mem: 0.5],
    aggressive:   [cpu: 0.95, mem: 0.95]
]

def cpuFrac = modeScale[params.resource_mode].cpu
def memFrac = modeScale[params.resource_mode].mem

def cpusPct = { pct -> Math.max(1, (maxCores * cpuFrac * pct / 100).toInteger()) }
def memPct  = { pct -> "${Math.max(4, (maxMemoryGB * memFrac * pct / 100).toInteger())} GB" }

// -------------------------------------------------
// Executor
// -------------------------------------------------
executor {
    name              = 'local'
    cpus              = maxCores
    memory            = "${maxMemoryGB} GB"
    queueSize         = 12
    submitRateLimit   = '5 sec'
    exitReadTimeout   = '270 sec'
    pollInterval      = '30 sec'
    queueStatInterval = '1 min'
}

// -------------------------------------------------
// Unified process configuration
// -------------------------------------------------
process {
    executor   = 'local'
    publishDir = params.output_dir

    errorStrategy = { task.exitStatus in [137,140,143] ? 'retry' : 'finish' }
    maxRetries    = 3
    maxRetryDelay = '2h'

    cpus   = { task.attempt > 1 ? Math.min(task.cpus * task.attempt, maxCores) : task.cpus }
    memory = { task.attempt > 1 ? task.memory * task.attempt : task.memory }
    time   = { task.attempt > 1 ? task.time * task.attempt : task.time }

    // ---------------- QC ----------------
    withName: fastpQC {
        container  = 'docker://biocontainers/fastp:v0.23.4-1'
        cpus       = cpusPct(25)
        memory     = memPct(20)
        time       = '4h'
        publishDir = "${params.output_dir}/filtered_fastp"
    }

    // ---------------- Alignment ----------------
    withName: bwaMem {
        container  = 'docker://biocontainers/bwa:v0.7.17-1'
        cpus       = cpusPct(80)
        memory     = memPct(75)
        time       = '12h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    // ---------------- BAM processing ----------------
    withName: sortSam {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpusPct(30)
        memory     = memPct(35)
        time       = '3h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    withName: flagstat {
        container  = 'docker://biocontainers/samtools:v1.17-1'
        cpus       = cpusPct(15)
        memory     = memPct(10)
        time       = '45m'
        publishDir = "${params.output_dir}/Mapsam"
    }

    withName: markDuplicates {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpusPct(40)
        memory     = memPct(60)
        time       = '6h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    // ---------------- BQSR ----------------
    withName: baseRecalibrator {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpusPct(85)
        memory     = memPct(70)
        time       = '10h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    withName: applyBQSR {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpusPct(35)
        memory     = memPct(45)
        time       = '4h'
        publishDir = "${params.output_dir}/Mapsam"
    }

    // ---------------- Variant Calling ----------------
    withName: haplotypeCaller {
        container  = 'docker://broadinstitute/gatk:4.6.2.0'
        cpus       = cpusPct(85)
        memory     = memPct(75)
        time       = '12h'
        publishDir = "${params.output_dir}/Germline_VCF"
    }

    // ---------------- Annotation ----------------
    withName: snpsiftAnnotate1000G {
        container  = 'docker://biocontainers/snpsift:4.3.1-1'
        cpus       = cpusPct(30)
        memory     = memPct(25)
        time       = '6h'
        publishDir = "${params.output_dir}/Germline_VCF"
    }

    withName: annovarAnnotate {
        container  = 'docker://biocontainers/annovar:20230520-1'
        cpus       = cpusPct(80)
        memory     = memPct(65)
        time       = '10h'
        publishDir = "${params.output_dir}/Germline_VCF"
    }

    withName: extractFilterFields {
        container  = 'docker://biocontainers/snpsift:4.3.1-1'
        cpus       = cpusPct(20)
        memory     = memPct(15)
        time       = '2h'
        publishDir = "${params.output_dir}/Germline_VCF"
    }
}

// -------------------------------------------------
// Profiles
// -------------------------------------------------
profiles {

    standard {
        process.executor = 'local'
    }

    slurm {
        process.executor = 'slurm'
        process.queue    = 'default'
        executor.queueSize = 20
    }

    docker {
        docker.enabled = true
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
    }

    conservative {
        params.resource_mode = 'conservative'
    }

    aggressive {
        params.resource_mode = 'aggressive'
    }
}

// -------------------------------------------------
// Reports
// -------------------------------------------------
trace {
    enabled = true
    file    = "${params.output_dir}/logs/trace.txt"
}

report {
    enabled = true
    file    = "${params.output_dir}/logs/report.html"
}

timeline {
    enabled = true
    file    = "${params.output_dir}/logs/timeline.html"
}

dag {
    enabled = true
    file    = "${params.output_dir}/logs/pipeline.svg"
}
